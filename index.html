<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Micro-frameworks Make Awesome APIs</title>

  <meta name="description" content="A presentation about making awesome APIs with micro-frameworks.">
  <meta name="author" content="Austin S. Morris">

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

  <link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="css/theme/night.css" id="theme">

  <!-- Code syntax highlighting -->
  <link rel="stylesheet" href="lib/css/zenburn.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>

  <!--[if lt IE 9]>
  <script src="lib/js/html5shiv.js"></script>
  <![endif]-->
</head>

<body>

  <div class="reveal">

    <div class="slides">

      <section>
        <h2>Micro-frameworks Make Awesome APIs</h2>
        <br>
        <strong>Austin S. Morris</strong><br>
        <a href="https://twitter.com/austinsmorris">@austinsmorris</a><br>
        <br>
        <hr><br>
        <small>Slides available at <a href="https://austinsmorris.github.io/micro-frameworks-make-awesome-apis">https://austinsmorris.github.io/micro-frameworks-make-awesome-apis</a></small>
      </section>

      <section>
        <section>
          <h2>About Me</h2>
        </section>
        <section>
          <h2>I PHP:</h2>
          <h4>First dabbled in college (early-2000s).</h4>
          <h4>Personal projects while masquerading as an aerospace engineer.</h4>
          <h4>Full stack development for last several years.</h4>
        </section>
        <section>
          <h2>For Money:</h2>
          <h3>Senior Software Engineer</h3>
          <h3><a href="http://varsitynewsnetwork.com">Varsity News Network</a></h3>
          <p>(We do the things in this presentation!)</p>
        </section>
        <section>
          <h2>For Free:</h2>
          <h3>Co-Author of <a href="https://peridot-php.github.io/">Peridot</a></h3>
          <p style="margin-left: -24px; margin-right: -24px;">The highly extensible, highly enjoyable, BDD testing framework for PHP.</p>
          <p>(Code samples in this presentation use peridot!)</p>
        </section>
      </section>

      <section>
        <section>
          <h2>I want an API!</h2>
        </section>
        <section>
          <h2>I want an <span style="text-decoration: underline;">awesome</span> API!</h2>
        </section>
        <section>
          <h2>What makes an awesome API?</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>An awesome API is...</h2>
        </section>
        <section>
          <h2>Domain Focused!</h2>
          <h4 class="fragment">My domain is my business.</h4>
          <h4 class="fragment">My business is my domain.</h4>
        </section>
        <section>
          <h2>An API supports the domain!</h2>
          <h4 class="fragment">How data is accessed.</h4>
          <h4 class="fragment">Actions taken on data.</h4>
          <h4 class="fragment">Business rules are applied to actions and data.</h4>
        </section>
        <section>
          <h2>So how should others </h2>
          <h2>interact with my API?</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>REST is cool!</h2>
          <h4 class="fragment">But, what is it?</h4>
        </section>
        <section>
          <h2>Richardson Maturity Model</h2>
          <h4>A measurement of your API's RESTfulness.</h4>
          <h4>Think of this from the client prospective.</h4>
        </section>
        <section>
          <h2>RMM Level 0</h2>
          <h4>Swamp of POX</h4>
          <p>
            POST or GET everything to/from a single api endpoint.<br>
            The request content determines the action.<br>
            (Remote Procedure Invocation)
          </p>
        </section>
        <section>
          <h2>RMM Level 1</h2>
          <h4>Resources</h4>
          <p>
            Divide and conquer complexity with different resource endpoints.<br>
            The request content still determines the action.<br>
          </p>
        </section>
        <section>
          <h2>RMM Level 2</h2>
          <h4>Protocol Standardization</h4>
          <p>
            Use the protocol (HTTP verbs) to determine resource actions.<br>
            GET a resource or collection.<br>
            DELETE a resource.<br>
            PATCH a resource.<br>
            POST to a collection.<br>
          </p>
        </section>
        <section>
          <h2>RMM Level 3</h2>
          <h4>Hypermedia As The Engine Of Application State</h4>
          <p>
            Use links to declare actions and resources.<br>
            Allows discoverability and automation.<br>
          </p>
        </section>
      </section>

      <section>
        <section>
          <h2>Requirement #1!</h2>
          <h4 class="fragment">RMM Level 1 Resources</h4>
          <h4 class="fragment">+</h4>
          <h4 class="fragment">RMM Level 2 Verbs</h4>
          <h4 class="fragment">=</h4>
        </section>
        <section>
          <h2>We need a router!</h2>
        </section>
        <section>
          <h2>What about RMM Level 3?</h2>
          <h4 class="fragment">This is part of your API design.</h4>
          <h4 class="fragment">(Not a requirement of your framework)</h4>
        </section>
      </section>

      <section>
        <section>
          <h2>An awesome API is...</62>
        </section>
        <section>
          <h2>Well Tested!</h2>
          <div class="fragment">
            <h4>Prefer unit testing.</h4>
            <p>(fast, stable, reliable)</p>
          </div>
          <div class="fragment">
            <h4>Resort to integration/functional testing.</h4>
            <p>(slower and more fragile)</p>
          </div>
        </section>
        <section>
          <h3>Code is easily tested when..</h3>
          <ul>
            <li class="fragment">It is isolated and singular in purpose.</li>
            <li class="fragment">External dependencies are injected.</li>
            <li class="fragment">Each piece has a simple public api.</li>
          </ul>
        </section>
      </section>

      <section>
        <section>
          <h2>An awesome API is...</h2>
        </section>
        <section>
          <h2>Maintainable!</h2>
          <div class="fragment">
            <h4>Testability and maintainablity</h4>
            <h4>go hand in hand.</h4>
          </div>
        </section>
        <section>
          <h2>Use good design principles.</h2>
          <h4 class="fragment">Loosely-coupled objects that depend on abstractions.</h4>
          <h4 class="fragment">Small highly-cohesive objects with a single responsibility.</h4>
          <h4 class="fragment">DRY, KISS, SOLID, etc...</h4>
        </section>
      </section>

      <section>
        <section>
          <h2>Requirement #2!</h2>
          <h4 class="fragment">Something has to inject those dependencies...</h4>
        </section>
        <section>
          <h2>We need an IOC layer!</h2>
          <h4>(Let's just call it the container.)</h4>
        </section>
        <section>
          <h3>The container will..</h3>
          <ul>
            <li class="fragment">Give us access to our domain services.</li>
            <li class="fragment">Resolve our dependency abstractions.</li>
            <li class="fragment">Glue layers of our application together.</li>
          </ul>
        </section>
      </section>

      <section>
        <section>
          <h2>An awesome API must...</h2>
        </section>
        <section>
          <h2>Respond to a Request!</h2>
          <h4>(And handle everything in between.)</h4>
        </section>
        <section>
          <h3>Authenticate</h3>
          <h3 class="fragment">Authorize</h3>
          <h3 class="fragment">Negotiate Content</h3>
          <h3 class="fragment">De-serialize</h3>
        </section>
        <section>
          <h3>Hydrate</h3>
          <h3 class="fragment">Validate</h3>
          <h3 class="fragment">Perform an action!</h3>
          <h3 class="fragment">Serialize</h3>
          <h3 class="fragment">Do even more things (post-request)</h3>
        </section>
        <section>
          <h2>How???</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Requirement #3!</h2>
        </section>
        <section>
          <h2>We need middlewares!</h2>
        </section>
        <section>
          <h3>Middleware is software that connects</h3>
          <h3>other software components.</h3>
          <br>
          <h4>For an API, it connects a request to a response.</h4>
        </section>
        <section>
          <h3>Middlewares can be placed:</h3>
          <ul>
            <li class="fragment"><h4>Before or after routing.</h4></li>
            <li class="fragment"><h4>Before or after route handling (the action).</h4></li>
            <li class="fragment"><h4>Before or after the response <pre><code>fastcgi_finish_request();</code></pre></h4></li>
          </ul>
        </section>
        <section>
          <h3>Middlewares give us many</h3>
          <h3>small, reusable pieces.</h3>
          <ul>
            <li class="fragment"><h4>Better testability.</h4></li>
            <li class="fragment"><h4>Better OOP</h4></li>
            <li class="fragment"><h4>Better domain access.</h4></li>
          </ul>
        </section>
        <section>
          <h2>Paul M. Jones:</h2>
          <p>"HTTP middleware is a <span style="font-weight: bold;">user interface</span> decoration system, where the user interface is the HTTP request (input) and HTTP response (output)."</p>
          <p>"HTTP middleware is <span style="font-weight: bold;">not for your Domain work</span>. The middleware is a path in to, and out of, the core Domain."</p>
        </section>
      </section>

      <section>
        <section>
          <h2>Putting it all together...</h2>
        </section>
        <section>
          <h2>Micro-Frameworks!</h2>
          <h4 class="fragment">A micro-framework glues together:</h4>
          <ul>
            <li class="fragment"><h4>Router</h4></li>
            <li class="fragment"><h4>Container</h4></li>
            <li class="fragment"><h4>Middlewares</h4></li>
          </ul>
          <h4 class="fragment">Into a working application</h4>
          <h4 class="fragment">that is focused on the domain.</h4>
        </section>
        <section>
          <h2>It's everything your API needs!</h2>
          <h4 class="fragment">(without the stuff it doesn't)</h4>
        </section>
        <section>
          <h2>What about full-stack frameworks?</h2>
          <h4 class="fragment">They are the stuff you don't need.</h4>
          <h4 class="fragment">All that stuff can be slower.</h4>
          <h4 class="fragment">Start with the simplest thing that works (be agile).</h4>
          <h4 class="fragment">Because awesome APIs are already hard enough!</h4>
        </section>
      </section>

      <section>
        <section>
          <h2>I haz teh codez!</h2>
        </section>
        <section>
          <h2>Micro-frameworks 101</h2>
        </section>
        <section>
          <h4>Hello Silex!</h4>
          <pre><code>
use Silex\Application;
use Symfony\Component\HttpFoundation\Response;

$app = new Application();

$app->get('/hello/world', function () {
  return new Response('Hello World!');
});

$app->run();
          </code></pre>
        </section>
        <section>
          <h4>Hello Lumen!</h4>
          <pre><code>
use Symfony\Component\HttpFoundation\Response;

$app = require __DIR__.'/../bootstrap/app.php';

$app->get('/hello/world', function () {
  return new Response('Hello World!');
});

$app->run();
          </code></pre>
        </section>
        <section>
          <h4>Non-trivial Silex!</h4>
          <pre><code>
$app['my.resource.repository'] = $app->share(function (Application $app) {
  return new My\Resource\Repository($app['my.db.connection']);
});

$app->get('my/resource/{id}', function ($app, $request, $id) {
  $token = $app['my.auth.token.repository']->find($request->get('access_token'));
  if (!$token) {
    return new Response('', Response::HTTP_UNAUTHORIZED);
  }

  $resource = $app['my.resource.repository']->find($id);
  if (!$resource) {
    return new Response('', Response::HTTP_NOT_FOUND);
  }

  return new Response(json_encode($resource->toArray()));
});
          </code></pre>
        </section>
        <section>
          <h4>Non-trivial Lumen!</h4>
          <pre><code style="margin-left: -24px; margin-right: -24px;">
$app->bind(Repository::class, function  () {
  return new My\Resource\Repository($app['my.db.connection']);
});

$app->get('my/resource/{id}', function ($id) use ($app) {
  $token = $app['My\Auth\Token\Repository']->find($app['request']->get('access_token'));
  if (!$token) {
    return new Response('', Response::HTTP_UNAUTHORIZED);
  }

  $resource = $app[Repository::class]->find(123);
  if (!$resource) {
    return new Response('', Response::HTTP_NOT_FOUND);
  }

  return new Response(json_encode($resource->toArray()));
});
          </code></pre>
        </section>
        <section>
          <h2>It's a trap!</h2>
          <br>
          <h3>Let's look again...</h3>
        </section>
        <section>
          <h4>Non-trivial Silex!</h4>
          <pre><code>
$app['my.resource.repository'] = $app->share(function (Application $app) {
  return new My\Resource\Repository($app['my.db.connection']);
});

$app->get('my/resource/{id}', function ($app, $request, $id) {
  $token = $app['my.auth.token.repository']->find($request->get('access_token'));
  if (!$token) {
    return new Response('', Response::HTTP_UNAUTHORIZED);
  }

  $resource = $app['my.resource.repository']->find($id);
  if (!$resource) {
    return new Response('', Response::HTTP_NOT_FOUND);
  }

  return new Response(json_encode($resource->toArray()));
});
          </code></pre>
        </section>
        <section>
          <h4>Non-trivial Lumen!</h4>
          <pre><code style="margin-left: -24px; margin-right: -24px;">
$app->bind(Repository::class, function  () {
  return new My\Resource\Repository($app['my.db.connection']);
});

$app->get('my/resource/{id}', function ($id) use ($app) {
  $token = $app['My\Auth\Token\Repository']->find($app['request']->get('access_token'));
  if (!$token) {
    return new Response('', Response::HTTP_UNAUTHORIZED);
  }

  $resource = $app[Repository::class]->find(123);
  if (!$resource) {
    return new Response('', Response::HTTP_NOT_FOUND);
  }

  return new Response(json_encode($resource->toArray()));
});
          </code></pre>
        </section>
        <section>
          <h4>Silex Controllers</h4>
          <pre><code>
$app->register(new Silex\Provider\ServiceControllerServiceProvider());

$app['my.resource.controller'] = $app->share(function ($app) {
  return new \My\Resource\Controller($app['my.resource.repository']);
});

$app->get('my/resource/{id}', 'my.resource.controller:get');
          </code></pre>
        </section>
        <section>
          <pre><code style="max-height: 500px;">namespace My\Resource;

use My\Resource\RepositoryInterface;
use Symfony\Component\HttpFoundation\Response;

class Controller
{
  protected $repo;

  public function __construct(RepositoryInterface $repo)
  {
    $this->repo = $repo;
  }

  public function get($app, $request, $id)
  {
    $resource = $this->repo->find($id);
    if (!$resource) {
      return new Response('', Response::HTTP_NOT_FOUND);
    }

    return new Response(json_encode($resource->toArray()));
  }
}
          </code></pre>
        </section>
        <section>
          <h4>Lumen Controllers</h4>
          <pre><code>
use My\Resource\Repository;
use My\Resource\RepositoryInterface;

$app->bind(RepositoryInterface::class, Repository::class);

$app->get('my/resource/{id}', 'ResourceController@get');
          </code></pre>
        </section>
        <section>
          <pre><code style="max-height: 500px;">namespace App\Http\Controllers;

use Laravel\Lumen\Routing\Controller as BaseController;
use My\Resource\RepositoryInterface;
use Symfony\Component\HttpFoundation\Response;

class ResourceController extends BaseController
{
  protected $repo;

  public function __construct(RepositoryInterface $repo)
  {
    $this->repo = $repo;
  }

  public function get($id)
  {
    $resource = $this->repo->find($id);
    if (!$resource) {
      return new Response('', Response::HTTP_NOT_FOUND);
    }

    return new Response(json_encode($resource->toArray()));
  }
}
          </code></pre>
        </section>
        <section>
          <h4>Silex Container</h4>
          <pre><code>
use Pimple;
// ...

class Application extends Pimple implements HttpKernelInterface, TerminableInterface
{
  // ...
}
          </code></pre>
        </section>
        <section>
          <pre><code>
$app['my.parameter'] = 123;

$app['my.service'] = function () { /* This function will be invoked */ };

$app['my.shared.service'] = $app->share(function ($app) {
  return $app['my.service']  // only instantiated once!
});

$foo = $app['the.thing.i.want'];
          </code></pre>
        </section>
        <section>
          <h4>Lumen Container</h4>
          <pre><code>
use Illuminate\Container\Container;
// ...

class Application extends Container implements ApplicationContract, HttpKernelInterface
{
  // ...
}
          </code></pre>
        </section>
        <section>
          <pre><code>
$app->instance('my.parameter', 123);

$app->bind('My\Service',  function () { /* This function will be invoked */ };

$app->singleton('My\Shared\Service', function ($app) {
  return $app['My\Service']  // only instantiated once!
});

$app->bind('My\Interface', 'My\Implementation');

$foo = $app['My\Thing'];
$bar = $app->make('My\Other\Thing');
          </code></pre>
        </section>
        <section>
          <h3>Plus...</h3>
          <h4 class="fragment">Auto-resolving</h4>
          <h4 class="fragment">Contextual Bindings</h4>
          <h4 class="fragment">Tagging</h4>
          <h4 class="fragment">Container Events</h4>
        </section>
        <section>
          <h4>Silex Middleware</h4>
          <pre><code>
$app->before('my.before.routing.middleware:doAThing');

$app->get('/my/resource', 'my.resource.controller:get')
  ->before('my.before.this.route.middlware:doSomething')
  ->after('my.after.this.route.middlware:doSomethingElse');

$app->after('my.after.route.after.middlewares:doMore');

$app->finish('my.after.response.is.returned.middleare:doSoemthingSlow');
          </code></pre>
        </section>
        <section>
          <pre><code>
namespace My\Middlware;

class BeforeRouteMiddlware
{
  protected $dependecy;

  public function __construct($dependency)
  {
    $this->dependency = $dependency;
  }

  public function doSomething($request, $app)
  {
    // do something..
  }
{
          </code></pre>
        </section>
        <section>
          <h4>Lumen Middleware</h4>
          <pre><code>
$app->middleware([
  App\Http\Middleware\BeforeRoutingMiddleware::class,
  App\Http\Middleware\AfterRoutingMiddleware::class,
  App\Http\Middleware\TerminableMiddleware::class,
]);

$app->routeMiddleware([
  'before' => App\Http\Middleware\BeforeRouteMiddleware::class,
  'after' => App\Http\Middleware\AfterRouteMiddleware::class,
]);

$app->get('my/resource/{id}', [
  'uses' => 'ResourceController@get',
  'middleware' => ['before', 'after'],
]);
          </code></pre>
        </section>
        <section>
          <pre><code>
use Closure;

class BeforeMiddleware
{
  public function handle($request, Closure $next)
  {
    // do something here
    return $next($request);
  }
}
          </code></pre>
          <pre><code>
use Closure;

class AfterMiddleware
{
  public function handle($request, Closure $next)
  {
    $response = $next($request);
    // do something here
    return $response;
  }
}
          </code></pre>
        </section>
        <section>
          <pre><code>
use Closure;

class TerminableMiddleware
{
  public function handle($request, Closure $next)
  {
    return $next($request);
  }

  public function terminate($request, $response)
  {
    // do stuff after the request was sent
  }
}
          </code></pre>
        </section>
      </section>





      <section>
        <section>
          <h2>Authentication</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Authorization</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Content Negotiation</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>De-serialization</h2>
        </section>
        <section>
          <pre><code>
            $app->post('/my/resource', 'my.controler:myAction')
                ->before('json.decode.middleware:decode');
          </code></pre>
        </section>
        <section>
          <pre><code>
            use Peridot\Leo\Interfaces\Assert;

            $assert = new Assert();
            $assert->typeOf('string', 'hello', 'is string');
            $assert->operator(5, '<', 6, 'should be less than');
            $assert->isResource(tempfile());
            $assert->throws(function() {
            throw new Exception("exception");
            }, 'Exception');
          </code></pre>
        </section>
      </section>

      <section>
        <section>
          <h2>Hydration</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Validation</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>[The Action]</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Serialization</h2>
        </section>
      </section>

      <section>
        <section>
          <h2>Other - post-request jobs</h2>
        </section>
      </section>

    </div>

  </div>

  <script src="lib/js/head.min.js"></script>
  <script src="js/reveal.js"></script>

  <script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: 'slide', // none/fade/slide/convex/concave/zoom

      // Optional reveal.js plugins
      dependencies: [
        { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
        { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'plugin/zoom-js/zoom.js', async: true },
        { src: 'plugin/notes/notes.js', async: true }
      ]
    });

  </script>

</body>

</html>
